// FB Controller to decode sensor output from the vision sensor in FactoryIO
// Sensor must be configured to 'All Digital' mode to output 4 bit sequences
FUNCTION_BLOCK FB_VisionSensorAD
VAR_INPUT
	iBit0 : BOOL;	// LSB, 4 sensor output bits from vision sensor 
	iBit1 : BOOL;
	iBit2 : BOOL;
	iBit3 : BOOL;	// MSB
END_VAR
VAR_OUTPUT
	bObjectDetected : BOOL;		// TRUE when the sensor detects something
	sObjectDetected : STRING;	// The object being detected
END_VAR
VAR
	ObjectCode : BYTE;			// Reconstructed bitwise code
END_VAR


// Reconstruct the object code
ObjectCode := BitsToByte(Bit0 := iBit0, Bit1 := iBit1, Bit2 := iBit2, Bit3 := iBit3);

// Decode the result
CASE ObjectCode OF
	0 : sObjectDetected := 'none';
	1 : sObjectDetected := 'blue raw material';
	2 : sObjectDetected := 'blue product lid';
	3 : sObjectDetected := 'blue product base';
	4 : sObjectDetected := 'green raw material';
	5 : sObjectDetected:= 'green product lid';
	6 : sObjectDetected := 'green product base';
	7 : sObjectDetected := 'metal raw material';
	8 : sObjectDetected:= 'metal product lid';
	9 : sObjectDetected := 'metal product base';
ELSE
	sObjectDetected := 'unknown';	
END_CASE

IF sObjectDetected = 'none' THEN
	bObjectDetected := FALSE;
ELSE
	bObjectDetected := TRUE;
END_IF